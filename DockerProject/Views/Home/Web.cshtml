@{
    ViewData["Title"] = "WhatsApp Style Chat";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    #chatBox {
        height: 400px;
        overflow-y: scroll;
        padding: 10px;
        background: #e5ddd5;
        border-radius: 10px;
    }

    .message {
        max-width: 70%;
        margin-bottom: 8px;
        padding: 10px 14px;
        border-radius: 15px;
        position: relative;
        word-wrap: break-word;
    }

    .sent {
        background-color: #dcf8c6;
        margin-left: auto;
        text-align: right;
    }

    .received {
        background-color: #ffffff;
        margin-right: auto;
        text-align: left;
    }

    .timestamp {
        font-size: 0.7em;
        color: gray;
        margin-top: 3px;
    }

    #typingIndicator {
        font-style: italic;
        margin-bottom: 5px;
    }
</style>

<div class="container mt-4">
    <h3>WhatsApp Style Chat</h3>

    <div class="mb-2">
        <input type="text" id="username" class="form-control mb-1" placeholder="Your name" />
        <input type="text" id="toUser" class="form-control" placeholder="Chat with (username)" />
    </div>

    <div id="chatBox"></div>
    <div id="typingIndicator"></div>

    <div class="input-group mt-2">
        <input type="text" id="message" class="form-control" placeholder="Type a message..." />
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        let username = '';
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        // Receive message
        connection.on("ReceiveMessage", function (fromUser, message) {
            const chatBox = document.getElementById("chatBox");
            const msgDiv = document.createElement("div");
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            msgDiv.className = "message " + (fromUser === username ? "sent" : "received");
            msgDiv.innerHTML = `<b>${message}<div class="timestamp">${timestamp}</div>`;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        // Typing indicator
        connection.on("UserTyping", function(user){
            const indicator = document.getElementById("typingIndicator");
            indicator.textContent = user + " is typing...";
            setTimeout(()=>indicator.textContent='', 1500);
        });

        // Registration confirmation
        connection.on("UserRegistered", function(name) {
            username = name;
            alert("Registered as " + name);
        });

        // Start connection
        connection.start().then(() => {
            document.getElementById("username").addEventListener("change", function() {
                username = this.value;
                connection.invoke("RegisterUser", username);
            });

            // Typing event
            document.getElementById("message").addEventListener("input", function(){
                const toUser = document.getElementById("toUser").value;
                if(username && toUser) connection.invoke("Typing", username, toUser);
            });
        }).catch(err => console.error(err.toString()));

        // Send message function
        function sendMessage() {
            const toUser = document.getElementById("toUser").value;
            const message = document.getElementById("message").value;
            if(!message || !toUser || !username) return;
            connection.invoke("SendPrivateMessage", username, toUser, message)
                .catch(err => console.error(err.toString()));
            document.getElementById("message").value = '';
        }
    </script>
}
